# CurateAI - Phase 4: Email Delivery with Paywall (Premium Feature)

## ğŸ¯ Copy this prompt into Replit AFTER Phase 3 is complete

-----

## Overview

Email delivery is the **premium feature** that converts free users to paying subscribers. The value proposition:

> **Free**: View your brief in the app (must log in)
> **Premium (IDR 79k/month)**: Get your brief delivered to email at your preferred time

This is like subscribing to a personal research analyst who emails you every morning.

-----

## Pricing Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PRICING TIERS                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     FREE        â”‚     PREMIUM        â”‚     ENTERPRISE         â”‚
â”‚                 â”‚   IDR 79,000/mo    â”‚   Contact Sales        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ View in app   â”‚ âœ“ Everything Free  â”‚ âœ“ Everything Premium   â”‚
â”‚ âœ“ 1x per day    â”‚ âœ“ Email delivery   â”‚ âœ“ Multiple users       â”‚
â”‚ âœ“ Save articles â”‚ âœ“ Custom time      â”‚ âœ“ Custom sources       â”‚
â”‚                 â”‚ âœ“ Breaking alerts  â”‚ âœ“ API access           â”‚
â”‚                 â”‚ âœ“ Archive access   â”‚ âœ“ Team dashboard       â”‚
â”‚                 â”‚ âœ“ Priority support â”‚ âœ“ Dedicated support    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

-----

## The Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EMAIL DELIVERY FLOW                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FREE USER views brief in app
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  "Want this delivered to your email?"   â”‚
â”‚  [Upgrade to Premium - IDR 79k/month]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ (User subscribes)
         
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PAYMENT (Midtrans/Stripe)       â”‚
â”‚                                         â”‚
â”‚  Card payment or bank transfer          â”‚
â”‚  Monthly recurring subscription         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PREMIUM USER SETTINGS           â”‚
â”‚                                         â”‚
â”‚  â€¢ Email: halim@email.com              â”‚
â”‚  â€¢ Delivery time: 6:00 AM              â”‚
â”‚  â€¢ Days: Mon-Fri                       â”‚
â”‚  â€¢ Breaking alerts: ON                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ (Every morning at configured time)
         
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AUTOMATED EMAIL DELIVERY        â”‚
â”‚                                         â”‚
â”‚  ğŸ“§ Beautiful HTML email                â”‚
â”‚  Personalized for this user             â”‚
â”‚  Sent via Resend API                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

-----

## Implementation

### 1. Database Schema Updates

```sql
-- Subscription plans
CREATE TABLE subscription_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(50) NOT NULL, -- 'free', 'premium', 'enterprise'
  price_idr INTEGER, -- 79000 for premium
  price_usd DECIMAL, -- For international users
  features JSONB,
  is_active BOOLEAN DEFAULT TRUE
);

-- Insert plans
INSERT INTO subscription_plans (name, price_idr, price_usd, features) VALUES
('free', 0, 0, '{"view_in_app": true, "email_delivery": false, "archive_days": 7}'),
('premium', 79000, 5, '{"view_in_app": true, "email_delivery": true, "archive_days": 90, "breaking_alerts": true}'),
('enterprise', null, null, '{"view_in_app": true, "email_delivery": true, "archive_days": 365, "api_access": true, "team_size": "unlimited"}');

-- User subscriptions
CREATE TABLE user_subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) UNIQUE,
  plan_id UUID REFERENCES subscription_plans(id),
  status VARCHAR(20) DEFAULT 'active', -- 'active', 'cancelled', 'past_due', 'trial'
  current_period_start TIMESTAMP,
  current_period_end TIMESTAMP,
  payment_provider VARCHAR(50), -- 'midtrans', 'stripe'
  payment_id VARCHAR(255), -- External payment reference
  created_at TIMESTAMP DEFAULT NOW(),
  cancelled_at TIMESTAMP
);

-- Email delivery preferences (premium only)
CREATE TABLE email_delivery_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) UNIQUE,
  email_address VARCHAR(255) NOT NULL,
  delivery_time TIME DEFAULT '06:00',
  delivery_days INTEGER[] DEFAULT ARRAY[1,2,3,4,5], -- 1=Mon, 7=Sun
  timezone VARCHAR(50) DEFAULT 'Asia/Jakarta',
  breaking_alerts BOOLEAN DEFAULT TRUE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Email delivery log
CREATE TABLE email_delivery_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  brief_id UUID REFERENCES daily_briefs(id),
  email_address VARCHAR(255),
  sent_at TIMESTAMP DEFAULT NOW(),
  status VARCHAR(20), -- 'sent', 'delivered', 'opened', 'clicked', 'bounced'
  resend_message_id VARCHAR(255),
  opened_at TIMESTAMP,
  click_count INTEGER DEFAULT 0
);

-- Add subscription reference to users
ALTER TABLE users ADD COLUMN subscription_status VARCHAR(20) DEFAULT 'free';
```

-----

### 2. Create Subscription Service

Create file: `server/services/subscriptionService.ts`

```typescript
import { db } from '../db';

export interface SubscriptionStatus {
  isPremium: boolean;
  plan: string;
  validUntil?: Date;
  features: {
    emailDelivery: boolean;
    breakingAlerts: boolean;
    archiveDays: number;
  };
}

// Check user's subscription status
export async function getSubscriptionStatus(userId: string): Promise<SubscriptionStatus> {
  const result = await db.query(`
    SELECT 
      us.status,
      us.current_period_end,
      sp.name as plan_name,
      sp.features
    FROM user_subscriptions us
    JOIN subscription_plans sp ON us.plan_id = sp.id
    WHERE us.user_id = $1
    AND us.status = 'active'
    AND us.current_period_end > NOW()
  `, [userId]);
  
  if (result.rows.length === 0) {
    // Free user
    return {
      isPremium: false,
      plan: 'free',
      features: {
        emailDelivery: false,
        breakingAlerts: false,
        archiveDays: 7
      }
    };
  }
  
  const sub = result.rows[0];
  const features = sub.features;
  
  return {
    isPremium: sub.plan_name !== 'free',
    plan: sub.plan_name,
    validUntil: sub.current_period_end,
    features: {
      emailDelivery: features.email_delivery || false,
      breakingAlerts: features.breaking_alerts || false,
      archiveDays: features.archive_days || 7
    }
  };
}

// Create or update subscription
export async function activateSubscription(
  userId: string,
  planName: string,
  paymentProvider: string,
  paymentId: string
): Promise<void> {
  // Get plan
  const planResult = await db.query(
    'SELECT id FROM subscription_plans WHERE name = $1',
    [planName]
  );
  
  if (planResult.rows.length === 0) {
    throw new Error('Plan not found');
  }
  
  const planId = planResult.rows[0].id;
  const periodStart = new Date();
  const periodEnd = new Date();
  periodEnd.setMonth(periodEnd.getMonth() + 1); // 1 month subscription
  
  await db.query(`
    INSERT INTO user_subscriptions (
      user_id, plan_id, status, current_period_start, current_period_end,
      payment_provider, payment_id
    ) VALUES ($1, $2, 'active', $3, $4, $5, $6)
    ON CONFLICT (user_id) DO UPDATE SET
      plan_id = $2,
      status = 'active',
      current_period_start = $3,
      current_period_end = $4,
      payment_provider = $5,
      payment_id = $6
  `, [userId, planId, periodStart, periodEnd, paymentProvider, paymentId]);
  
  // Update user status
  await db.query(
    'UPDATE users SET subscription_status = $1 WHERE id = $2',
    [planName, userId]
  );
}

// Cancel subscription
export async function cancelSubscription(userId: string): Promise<void> {
  await db.query(`
    UPDATE user_subscriptions 
    SET status = 'cancelled', cancelled_at = NOW()
    WHERE user_id = $1
  `, [userId]);
  
  await db.query(
    'UPDATE users SET subscription_status = $1 WHERE id = $2',
    ['free', userId]
  );
}
```

-----

### 3. Create Email Delivery Service

Create file: `server/services/emailDeliveryService.ts`

```typescript
import { Resend } from 'resend';
import { db } from '../db';
import { getSubscriptionStatus } from './subscriptionService';

const resend = new Resend(process.env.RESEND_API_KEY);

interface EmailSettings {
  emailAddress: string;
  deliveryTime: string;
  deliveryDays: number[];
  timezone: string;
  breakingAlerts: boolean;
}

// Get user's email delivery settings
export async function getEmailSettings(userId: string): Promise<EmailSettings | null> {
  const result = await db.query(
    'SELECT * FROM email_delivery_settings WHERE user_id = $1 AND is_active = true',
    [userId]
  );
  
  if (result.rows.length === 0) return null;
  
  const settings = result.rows[0];
  return {
    emailAddress: settings.email_address,
    deliveryTime: settings.delivery_time,
    deliveryDays: settings.delivery_days,
    timezone: settings.timezone,
    breakingAlerts: settings.breaking_alerts
  };
}

// Update email delivery settings
export async function updateEmailSettings(
  userId: string, 
  settings: Partial<EmailSettings>
): Promise<void> {
  // Check if user is premium
  const subscription = await getSubscriptionStatus(userId);
  
  if (!subscription.features.emailDelivery) {
    throw new Error('Email delivery requires Premium subscription');
  }
  
  await db.query(`
    INSERT INTO email_delivery_settings (
      user_id, email_address, delivery_time, delivery_days, timezone, breaking_alerts
    ) VALUES ($1, $2, $3, $4, $5, $6)
    ON CONFLICT (user_id) DO UPDATE SET
      email_address = COALESCE($2, email_delivery_settings.email_address),
      delivery_time = COALESCE($3, email_delivery_settings.delivery_time),
      delivery_days = COALESCE($4, email_delivery_settings.delivery_days),
      timezone = COALESCE($5, email_delivery_settings.timezone),
      breaking_alerts = COALESCE($6, email_delivery_settings.breaking_alerts)
  `, [
    userId,
    settings.emailAddress,
    settings.deliveryTime,
    settings.deliveryDays,
    settings.timezone,
    settings.breakingAlerts
  ]);
}

// Generate beautiful email HTML
function generateBriefEmailHTML(brief: any, userName: string): string {
  const formatItem = (item: any) => `
    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #1e40af;">
      <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 600;">
        ${item.title}
      </h3>
      <p style="margin: 0 0 12px 0; color: #475569; font-size: 14px; line-height: 1.6;">
        ${item.summary}
      </p>
      <div style="background: #dbeafe; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
        <p style="margin: 0; color: #1e40af; font-size: 13px;">
          ğŸ’¡ <strong>Why this matters to you:</strong> ${item.whyItMatters}
        </p>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="color: #64748b; font-size: 12px;">ğŸ“° ${item.source}</span>
        ${item.url && item.url !== 'search required' ? 
          `<a href="${item.url}" style="color: #2563eb; font-size: 12px; text-decoration: none;">Read full article â†’</a>` 
          : ''}
      </div>
    </div>
  `;

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9;">
  <div style="max-width: 600px; margin: 0 auto; background: white;">
    
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); padding: 32px; text-align: center;">
      <h1 style="color: white; margin: 0; font-size: 28px;">ğŸ“Š CurateAI</h1>
      <p style="color: #bfdbfe; margin: 8px 0 0 0; font-size: 14px;">Your Personal Intelligence Brief</p>
    </div>
    
    <!-- Greeting -->
    <div style="padding: 24px 32px; border-bottom: 1px solid #e2e8f0;">
      <p style="color: #1e293b; font-size: 18px; margin: 0;">
        ${brief.greeting}
      </p>
      <p style="color: #64748b; font-size: 14px; margin: 8px 0 0 0;">
        ğŸ“… ${brief.briefDate}
      </p>
    </div>
    
    <!-- Executive Summary -->
    <div style="padding: 24px 32px; background: #eff6ff; border-bottom: 1px solid #bfdbfe;">
      <h2 style="color: #1e40af; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px 0;">
        ğŸ“‹ Executive Summary
      </h2>
      <p style="color: #1e293b; font-size: 16px; line-height: 1.6; margin: 0;">
        ${brief.executiveSummary}
      </p>
      
      <!-- Stats -->
      <div style="display: flex; gap: 16px; margin-top: 20px;">
        <div style="flex: 1; background: #fef2f2; padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #dc2626;">${brief.critical?.length || 0}</div>
          <div style="font-size: 12px; color: #991b1b;">Critical</div>
        </div>
        <div style="flex: 1; background: #fefce8; padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #ca8a04;">${brief.important?.length || 0}</div>
          <div style="font-size: 12px; color: #854d0e;">Important</div>
        </div>
        <div style="flex: 1; background: #f0fdf4; padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #16a34a;">${brief.background?.length || 0}</div>
          <div style="font-size: 12px; color: #166534;">Background</div>
        </div>
      </div>
    </div>
    
    ${brief.critical?.length > 0 ? `
    <!-- Critical Section -->
    <div style="padding: 24px 32px;">
      <h2 style="color: #dc2626; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
        ğŸ”´ REQUIRES YOUR ATTENTION
      </h2>
      ${brief.critical.map(formatItem).join('')}
    </div>
    ` : ''}
    
    ${brief.important?.length > 0 ? `
    <!-- Important Section -->
    <div style="padding: 24px 32px; background: #fffbeb;">
      <h2 style="color: #ca8a04; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 16px 0;">
        ğŸŸ¡ WORTH KNOWING
      </h2>
      ${brief.important.map(formatItem).join('')}
    </div>
    ` : ''}
    
    ${brief.background?.length > 0 ? `
    <!-- Background Section -->
    <div style="padding: 24px 32px;">
      <h2 style="color: #16a34a; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 16px 0;">
        ğŸŸ¢ ON YOUR RADAR
      </h2>
      ${brief.background.map((item: any) => `
        <div style="padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
          <p style="margin: 0; color: #1e293b; font-size: 14px;">
            â€¢ <strong>${item.title}</strong> 
            <span style="color: #64748b; font-size: 12px;">(${item.source})</span>
          </p>
        </div>
      `).join('')}
    </div>
    ` : ''}
    
    <!-- Feedback -->
    <div style="padding: 24px 32px; background: #f8fafc; text-align: center;">
      <p style="color: #475569; font-size: 14px; margin: 0 0 16px 0;">How was today's brief?</p>
      <div>
        <a href="#good" style="text-decoration: none; font-size: 28px; margin: 0 8px;">ğŸ˜Š</a>
        <a href="#okay" style="text-decoration: none; font-size: 28px; margin: 0 8px;">ğŸ˜</a>
        <a href="#poor" style="text-decoration: none; font-size: 28px; margin: 0 8px;">ğŸ˜</a>
      </div>
    </div>
    
    <!-- Footer -->
    <div style="padding: 24px 32px; background: #1e293b; text-align: center;">
      <p style="color: #94a3b8; font-size: 12px; margin: 0;">
        Powered by LLM Council: GPT-4 â€¢ Gemini â€¢ DeepSeek â€¢ Grok â€¢ Claude
      </p>
      <p style="color: #64748b; font-size: 11px; margin: 12px 0 0 0;">
        <a href="#dashboard" style="color: #60a5fa;">View in App</a> â€¢ 
        <a href="#settings" style="color: #60a5fa;">Email Settings</a> â€¢ 
        <a href="#unsubscribe" style="color: #60a5fa;">Unsubscribe</a>
      </p>
    </div>
    
  </div>
</body>
</html>`;
}

// Send daily brief email
export async function sendDailyBriefEmail(
  userId: string,
  briefId: string,
  brief: any
): Promise<{ success: boolean; messageId?: string; error?: string }> {
  try {
    // Check subscription
    const subscription = await getSubscriptionStatus(userId);
    if (!subscription.features.emailDelivery) {
      return { success: false, error: 'Email delivery requires Premium subscription' };
    }
    
    // Get email settings
    const settings = await getEmailSettings(userId);
    if (!settings) {
      return { success: false, error: 'Email settings not configured' };
    }
    
    // Get user name
    const userResult = await db.query('SELECT full_name FROM users WHERE id = $1', [userId]);
    const userName = userResult.rows[0]?.full_name || 'there';
    
    // Send email
    const { data, error } = await resend.emails.send({
      from: 'CurateAI <brief@curateai.id>',
      to: settings.emailAddress,
      subject: `ğŸ“Š Your Daily Brief - ${brief.briefDate} | ${brief.critical?.length || 0} critical, ${brief.important?.length || 0} important`,
      html: generateBriefEmailHTML(brief, userName),
      tags: [
        { name: 'type', value: 'daily_brief' },
        { name: 'user_id', value: userId }
      ]
    });
    
    if (error) {
      // Log failure
      await db.query(`
        INSERT INTO email_delivery_log (user_id, brief_id, email_address, status)
        VALUES ($1, $2, $3, 'failed')
      `, [userId, briefId, settings.emailAddress]);
      
      return { success: false, error: error.message };
    }
    
    // Log success
    await db.query(`
      INSERT INTO email_delivery_log (user_id, brief_id, email_address, status, resend_message_id)
      VALUES ($1, $2, $3, 'sent', $4)
    `, [userId, briefId, settings.emailAddress, data?.id]);
    
    return { success: true, messageId: data?.id };
    
  } catch (err: any) {
    console.error('Email delivery error:', err);
    return { success: false, error: err.message };
  }
}

// Send to all premium users at their scheduled time
export async function sendScheduledEmails(hour: number): Promise<void> {
  console.log(`\nğŸ“§ Sending emails for ${hour}:00...`);
  
  const users = await db.query(`
    SELECT 
      u.id, u.full_name, u.email,
      eds.email_address, eds.delivery_days,
      db.id as brief_id, db.content
    FROM users u
    JOIN email_delivery_settings eds ON u.id = eds.user_id
    JOIN user_subscriptions us ON u.id = us.user_id
    JOIN subscription_plans sp ON us.plan_id = sp.id
    JOIN daily_briefs db ON u.id = db.user_id AND DATE(db.generated_at) = CURRENT_DATE
    WHERE eds.is_active = true
    AND EXTRACT(HOUR FROM eds.delivery_time) = $1
    AND us.status = 'active'
    AND us.current_period_end > NOW()
    AND sp.features->>'email_delivery' = 'true'
    AND NOT EXISTS (
      SELECT 1 FROM email_delivery_log edl 
      WHERE edl.brief_id = db.id AND edl.status = 'sent'
    )
  `, [hour]);
  
  console.log(`Found ${users.rows.length} users to email`);
  
  for (const user of users.rows) {
    // Check if today is a delivery day
    const today = new Date().getDay() || 7; // Convert Sunday from 0 to 7
    if (!user.delivery_days.includes(today)) {
      console.log(`Skipping ${user.full_name} - not a delivery day`);
      continue;
    }
    
    const result = await sendDailyBriefEmail(
      user.id,
      user.brief_id,
      user.content
    );
    
    if (result.success) {
      console.log(`âœ… Sent to ${user.email_address}`);
    } else {
      console.log(`âŒ Failed for ${user.email_address}: ${result.error}`);
    }
    
    // Rate limit
    await new Promise(resolve => setTimeout(resolve, 500));
  }
}
```

-----

### 4. Create Payment Integration (Midtrans for Indonesia)

Create file: `server/services/paymentService.ts`

```typescript
// Using Midtrans for Indonesian payments
// npm install midtrans-client

import midtransClient from 'midtrans-client';
import { db } from '../db';
import { activateSubscription } from './subscriptionService';

// Initialize Midtrans Snap
const snap = new midtransClient.Snap({
  isProduction: process.env.NODE_ENV === 'production',
  serverKey: process.env.MIDTRANS_SERVER_KEY!,
  clientKey: process.env.MIDTRANS_CLIENT_KEY!
});

interface CreatePaymentParams {
  userId: string;
  userEmail: string;
  userName: string;
  planName: string;
  amount: number;
}

// Create payment transaction
export async function createPaymentTransaction(params: CreatePaymentParams): Promise<{
  token: string;
  redirectUrl: string;
}> {
  const orderId = `CURATE-${params.userId.substring(0, 8)}-${Date.now()}`;
  
  const transaction = await snap.createTransaction({
    transaction_details: {
      order_id: orderId,
      gross_amount: params.amount
    },
    customer_details: {
      email: params.userEmail,
      first_name: params.userName
    },
    item_details: [{
      id: params.planName,
      price: params.amount,
      quantity: 1,
      name: `CurateAI ${params.planName.charAt(0).toUpperCase() + params.planName.slice(1)} - Monthly`
    }],
    callbacks: {
      finish: `${process.env.APP_URL}/payment/success`,
      error: `${process.env.APP_URL}/payment/error`,
      pending: `${process.env.APP_URL}/payment/pending`
    }
  });
  
  // Store pending transaction
  await db.query(`
    INSERT INTO payment_transactions (
      order_id, user_id, amount, plan_name, status
    ) VALUES ($1, $2, $3, $4, 'pending')
  `, [orderId, params.userId, params.amount, params.planName]);
  
  return {
    token: transaction.token,
    redirectUrl: transaction.redirect_url
  };
}

// Handle Midtrans webhook notification
export async function handlePaymentNotification(notification: any): Promise<void> {
  const orderId = notification.order_id;
  const transactionStatus = notification.transaction_status;
  const fraudStatus = notification.fraud_status;
  
  console.log(`Payment notification: ${orderId} - ${transactionStatus}`);
  
  // Get transaction from DB
  const txResult = await db.query(
    'SELECT * FROM payment_transactions WHERE order_id = $1',
    [orderId]
  );
  
  if (txResult.rows.length === 0) {
    console.error('Transaction not found:', orderId);
    return;
  }
  
  const tx = txResult.rows[0];
  
  // Handle different statuses
  if (transactionStatus === 'capture' || transactionStatus === 'settlement') {
    if (fraudStatus === 'accept' || !fraudStatus) {
      // Payment successful - activate subscription
      await activateSubscription(
        tx.user_id,
        tx.plan_name,
        'midtrans',
        orderId
      );
      
      await db.query(
        'UPDATE payment_transactions SET status = $1 WHERE order_id = $2',
        ['success', orderId]
      );
      
      console.log(`âœ… Subscription activated for user ${tx.user_id}`);
    }
  } else if (transactionStatus === 'deny' || transactionStatus === 'expire' || transactionStatus === 'cancel') {
    await db.query(
      'UPDATE payment_transactions SET status = $1 WHERE order_id = $2',
      ['failed', orderId]
    );
  }
}
```

-----

### 5. Create API Routes for Subscription & Payment

Create file: `server/routes/subscription.ts`

```typescript
import { Router } from 'express';
import { getSubscriptionStatus, cancelSubscription } from '../services/subscriptionService';
import { getEmailSettings, updateEmailSettings } from '../services/emailDeliveryService';
import { createPaymentTransaction, handlePaymentNotification } from '../services/paymentService';
import { db } from '../db';

const router = Router();

// Get subscription status
router.get('/api/subscription', async (req, res) => {
  try {
    const userId = req.user?.id;
    if (!userId) return res.status(401).json({ error: 'Not authenticated' });
    
    const status = await getSubscriptionStatus(userId);
    res.json(status);
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

// Get email settings
router.get('/api/subscription/email-settings', async (req, res) => {
  try {
    const userId = req.user?.id;
    if (!userId) return res.status(401).json({ error: 'Not authenticated' });
    
    const settings = await getEmailSettings(userId);
    res.json(settings || { configured: false });
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

// Update email settings (premium only)
router.put('/api/subscription/email-settings', async (req, res) => {
  try {
    const userId = req.user?.id;
    if (!userId) return res.status(401).json({ error: 'Not authenticated' });
    
    await updateEmailSettings(userId, req.body);
    res.json({ success: true });
  } catch (error: any) {
    res.status(400).json({ error: error.message });
  }
});

// Create payment for upgrade
router.post('/api/subscription/upgrade', async (req, res) => {
  try {
    const userId = req.user?.id;
    if (!userId) return res.status(401).json({ error: 'Not authenticated' });
    
    const { planName } = req.body;
    
    // Get user info
    const userResult = await db.query(
      'SELECT email, full_name FROM users WHERE id = $1',
      [userId]
    );
    const user = userResult.rows[0];
    
    // Get plan price
    const planResult = await db.query(
      'SELECT price_idr FROM subscription_plans WHERE name = $1',
      [planName]
    );
    const plan = planResult.rows[0];
    
    if (!plan) {
      return res.status(400).json({ error: 'Invalid plan' });
    }
    
    const payment = await createPaymentTransaction({
      userId,
      userEmail: user.email,
      userName: user.full_name,
      planName,
      amount: plan.price_idr
    });
    
    res.json(payment);
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

// Midtrans webhook
router.post('/api/webhooks/midtrans', async (req, res) => {
  try {
    await handlePaymentNotification(req.body);
    res.status(200).send('OK');
  } catch (error: any) {
    console.error('Webhook error:', error);
    res.status(500).send('Error');
  }
});

// Cancel subscription
router.post('/api/subscription/cancel', async (req, res) => {
  try {
    const userId = req.user?.id;
    if (!userId) return res.status(401).json({ error: 'Not authenticated' });
    
    await cancelSubscription(userId);
    res.json({ success: true });
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

export default router;
```

-----

### 6. Create Upgrade UI Component

Create file: `client/src/components/UpgradeModal.tsx`

```tsx
import { useState } from 'react';
import { X, Mail, Clock, Bell, Check, CreditCard } from 'lucide-react';

interface UpgradeModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export function UpgradeModal({ isOpen, onClose }: UpgradeModalProps) {
  const [loading, setLoading] = useState(false);
  
  if (!isOpen) return null;
  
  const handleUpgrade = async () => {
    setLoading(true);
    try {
      const res = await fetch('/api/subscription/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ planName: 'premium' })
      });
      
      const data = await res.json();
      
      if (data.redirectUrl) {
        // Redirect to Midtrans payment page
        window.location.href = data.redirectUrl;
      }
    } catch (err) {
      console.error('Upgrade error:', err);
    }
    setLoading(false);
  };
  
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl max-w-lg w-full overflow-hidden shadow-xl">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-6 relative">
          <button
            onClick={onClose}
            className="absolute top-4 right-4 text-white/70 hover:text-white"
          >
            <X size={24} />
          </button>
          <h2 className="text-2xl font-bold">Upgrade to Premium</h2>
          <p className="text-blue-200 mt-1">Get your brief delivered to your inbox</p>
        </div>
        
        {/* Pricing */}
        <div className="p-6">
          <div className="text-center mb-6">
            <div className="text-4xl font-bold text-gray-900">
              IDR 79.000
              <span className="text-lg font-normal text-gray-500">/month</span>
            </div>
          </div>
          
          {/* Features */}
          <div className="space-y-4 mb-8">
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                <Check className="w-4 h-4 text-green-600" />
              </div>
              <div>
                <p className="font-medium text-gray-900">Email Delivery</p>
                <p className="text-sm text-gray-500">Get your personalized brief in your inbox</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                <Check className="w-4 h-4 text-green-600" />
              </div>
              <div>
                <p className="font-medium text-gray-900">Custom Delivery Time</p>
                <p className="text-sm text-gray-500">Choose when you want your brief (5 AM - 8 AM)</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                <Check className="w-4 h-4 text-green-600" />
              </div>
              <div>
                <p className="font-medium text-gray-900">Breaking Alerts</p>
                <p className="text-sm text-gray-500">Get notified about critical news immediately</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                <Check className="w-4 h-4 text-green-600" />
              </div>
              <div>
                <p className="font-medium text-gray-900">90-Day Archive</p>
                <p className="text-sm text-gray-500">Access your past briefs anytime</p>
              </div>
            </div>
          </div>
          
          {/* CTA */}
          <button
            onClick={handleUpgrade}
            disabled={loading}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-semibold text-lg transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {loading ? (
              'Processing...'
            ) : (
              <>
                <CreditCard className="w-5 h-5" />
                Subscribe Now
              </>
            )}
          </button>
          
          <p className="text-center text-xs text-gray-400 mt-4">
            Cancel anytime. Secure payment via Midtrans.
          </p>
        </div>
      </div>
    </div>
  );
}
```

-----

### 7. Update Cron Job for Email Delivery

Update file: `server/cron/emailDelivery.ts`

```typescript
import cron from 'node-cron';
import { sendScheduledEmails } from '../services/emailDeliveryService';

// Run every hour from 5 AM to 8 AM Jakarta time
// 5 AM WIB = 10 PM UTC (previous day)
// 6 AM WIB = 11 PM UTC
// 7 AM WIB = 12 AM UTC
// 8 AM WIB = 1 AM UTC

cron.schedule('0 22 * * *', () => sendScheduledEmails(5)); // 5 AM WIB
cron.schedule('0 23 * * *', () => sendScheduledEmails(6)); // 6 AM WIB
cron.schedule('0 0 * * *', () => sendScheduledEmails(7));  // 7 AM WIB
cron.schedule('0 1 * * *', () => sendScheduledEmails(8));  // 8 AM WIB

console.log('ğŸ“§ Email delivery cron jobs scheduled');
```

-----

## Testing Checklist

1. [ ] Create subscription tables in database
1. [ ] Set up Midtrans account and get API keys
1. [ ] Implement subscription service
1. [ ] Implement email delivery service
1. [ ] Create payment routes
1. [ ] Add upgrade modal to UI
1. [ ] Test payment flow
1. [ ] Verify email delivery for premium users

-----

## Environment Variables to Add

```env
# Midtrans (for Indonesian payments)
MIDTRANS_SERVER_KEY=...
MIDTRANS_CLIENT_KEY=...

# Or Stripe (for international)
STRIPE_SECRET_KEY=...
STRIPE_PUBLISHABLE_KEY=...

# Resend (already from Phase 2)
RESEND_API_KEY=...
```

-----

## Summary of 4 Phases

|Phase|Feature                  |Status                         |
|-----|-------------------------|-------------------------------|
|1    |Conversational Onboarding|Creates unique user profile    |
|2    |LLM Council              |Uses personalized system prompt|
|3    |Brief Display            |Shows in app (free)            |
|4    |Email Delivery           |Premium feature (IDR 79k/mo)   |

-----

ğŸ‰ **All 4 phases complete!** You now have a full product that:

- Deeply understands each user through conversation
- Uses 5 AI models to find relevant news
- Validates with Claude as judge
- Displays in a beautiful dashboard
- Delivers to email for premium users

Ready to validate with Pak Halim! ğŸš€